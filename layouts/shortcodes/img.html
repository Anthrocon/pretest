{{/*
	src
		Relative file location of image in page bundle, or in assets/images/.

	alt
		Text img alt attribute.

	hint
		One of drawing, icon, photo, picture, or text. Pre-defined WebP encoding parameters.

	filter
		Additional encoding parameters.

	link
		URL for image link.

	caption
		Markdown text appears centered below image.

	attr
		Markdown text appears centered after image.

	attrlink
		URL for attr link.
*/}}

{{- $resWidths := slice "240" "480" "720" "960" "1200" "1440" "1680" "1920" "2160" "2400" "2640" "2880" "3120" "3360" "3600" "3840" -}}
{{- $sourceSizes := "(min-width: 800px) 800px, 100vw" -}}

{{- $src := .Page.Resources.GetMatch (.Get "src") -}}
{{- if not $src -}}
	{{- $src = resources.Get (printf "images/%s" (.Get "src")) -}}
{{- end -}}

{{- $hint := "" -}}
{{- with .Get "hint" -}}
	{{- $hint = printf " %s" . -}}
{{- end -}}
{{- $filter := "" -}}
{{- with .Get "filter" -}}
	{{- $filter = printf " %s" . -}}
{{- end -}}

{{- $lqipBin := $src.Resize (printf "16x jpg%s" $filter) -}}
{{- $lqipB64 := $lqipBin.Content | base64Encode -}}
{{- $divStyle := printf "background-image: url(data:image/jpeg;base64,%s);" $lqipB64 -}}

{{- if or (.Get "caption") (.Get "attr") }}<figure>{{ end }}
	<div class="lqip" style="{{ $divStyle | safeCSS }}">
		{{ with .Get "link" }}<a href="{{ . }}">{{ end }}
			<picture>
				<source type="image/webp" srcset="
					{{- with $resWidths -}}
						{{- range $i, $e := . -}}
							{{- if ge $src.Width . -}}
								{{- if $i }}, {{ end }}{{ ($src.Resize (printf "%sx webp%s%s" . $hint $filter)).RelPermalink }} {{ . }}w
							{{- end -}}
						{{- end -}}
					{{- end }}" sizes="{{ $sourceSizes }}">
				<source type="image/jpeg" srcset="
					{{- with $resWidths -}}
						{{- range $i, $e := . -}}
							{{- if ge $src.Width . -}}
								{{- if $i }}, {{ end }}{{ ($src.Resize (printf "%sx jpg%s" . $filter)).RelPermalink }} {{ . }}w
							{{- end -}}
						{{- end -}}
					{{- end }}" sizes="{{ $sourceSizes }}">
				<img class="h-auto" src="{{ ($src.Resize (printf "760x jpg%s" $filter)).RelPermalink }}" alt="{{ with .Get "alt" }}{{ . }}{{ else }}{{ .Get "caption" | markdownify | plainify }}{{ end }}" width="{{ $src.Width }}" height="{{ $src.Height }}">
			</picture>
		{{ if .Get "link" }}</a>{{ end }}
	</div>
	{{ if or (.Get "caption") (.Get "attr") }}<figcaption class="center">
		{{- .Get "caption" | markdownify -}}
		{{- if .Get "attr" }} â€” {{ with .Get "attrlink" }}<a href="{{ . }}">{{ end }}{{ .Get "attr" | markdownify }}{{ if .Get "attrlink" }}</a>{{ end }}{{ end -}}
	</figcaption>
</figure>{{ end -}}
